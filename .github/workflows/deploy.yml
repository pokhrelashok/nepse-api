name: Deploy to Droplet

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Validate secrets
        run: |
          [[ -n "${{ secrets.DO_HOST }}" ]] || { echo "DO_HOST missing"; exit 1; }
          [[ -n "${{ secrets.DO_USER }}" ]] || { echo "DO_USER missing"; exit 1; }
          [[ -n "${{ secrets.DO_SSH_KEY }}" ]] || { echo "DO_SSH_KEY missing"; exit 1; }
          echo "Secrets look ok"
      - name: SSH deploy
        uses: appleboy/ssh-action@v1.2.0
        with:
          host: ${{ secrets.DO_HOST }}
          username: ${{ secrets.DO_USER }}
          key: ${{ secrets.DO_SSH_KEY }}
          port: ${{ secrets.DO_PORT || 22 }}
          script: |
            set -e
            APP_DIR="${{ secrets.APP_DIR }}"
            APP_DIR=${APP_DIR:-/var/www/nepse-api}
            REPO="https://github.com/${{ github.repository }}.git"

            mkdir -p "$APP_DIR"
            cd "$APP_DIR"
            git config --global --add safe.directory "$APP_DIR"

            if [ -d .git ]; then
              git fetch origin main
              git reset --hard origin/main
            else
              git init
              git remote add origin "$REPO"
              git fetch origin main
              git checkout -f origin/main
            fi

            # Refresh the update script from the repository
            # deploy/scripts/update-app.sh is now the Bun-native script
            if [ -f deploy/scripts/update-app.sh ]; then
              cp deploy/scripts/update-app.sh ./update.sh
              sed -i "s|APP_DIR_PLACEHOLDER|$APP_DIR|g" ./update.sh
              chmod +x ./update.sh
            fi

            if [ -x ./update.sh ]; then
              echo "ðŸ”¥ Deploying with Bun..."
              ./update.sh
            else
              echo "update.sh missing; running inline Bun update"
              # Fallback Bun deployment
              # Ensure variables are loaded for DB/etc if needed during build?
              # usually bun install doesn't need them. migrate might.
              
              # Assuming Bun is in path or using full path
              BUN_BIN="/usr/local/bin/bun"
              $BUN_BIN install
              $BUN_BIN run bun:migrate
              
              cd frontend 
              $BUN_BIN install 
              $BUN_BIN run build 
              cd ..
              
              # Restart PM2
              pm2 restart ecosystem.config.js || pm2 start ecosystem.config.js
            fi
